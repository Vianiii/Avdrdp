name: VNC-RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install VNC Server (x11vnc)
        run: |
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            xfce4 xfce4-terminal x11vnc xvfb wget git curl dbus-x11

          echo "✅ VNC + XFCE installed"

      - name: Create User
        run: |
          PASSWORD=$(openssl rand -base64 12 | head -c 15)

          sudo useradd -m -s /bin/bash RDP 2>/dev/null || true
          echo "RDP:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo,video,audio RDP

          mkdir -p /home/RDP/.vnc
          echo "$PASSWORD" | vncpasswd -f > /home/RDP/.vnc/passwd
          chmod 600 /home/RDP/.vnc/passwd

          echo "RDP_CREDS=User: RDP | Password: $PASSWORD" >> $GITHUB_ENV
          echo "✅ User created"

      - name: Start Virtual Display & VNC
        run: |
          # Start Xvfb
          Xvfb :99 -screen 0 1920x1080x24 -nolisten tcp > /tmp/xvfb.log 2>&1 &
          export DISPLAY=:99
          sleep 3

          # Start XFCE
          startxfce4 > /tmp/xfce.log 2>&1 &
          sleep 5

          # Start VNC server
          x11vnc -display :99 -forever -usepw -rfbport 5900 -nolisten unix -bg

          sleep 3
          ps aux | grep -E "x11vnc|Xvfb|xfce4" | grep -v grep

          echo "✅ VNC running on port 5900"

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable tailscaled
          sudo systemctl start tailscaled
          sleep 5

          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-${{ github.run_id }}

          TAILSCALE_IP=""
          for i in {1..10}; do
            TAILSCALE_IP=$(sudo tailscale ip -4)
            [ -n "$TAILSCALE_IP" ] && break
            sleep 5
          done

          if [ -z "$TAILSCALE_IP" ]; then
            echo "❌ Tailscale failed"
            exit 1
          fi

          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "✅ Tailscale: $TAILSCALE_IP"

      - name: Display Connection Info
        run: |
          echo ""
          echo "=== VNC ACCESS ==="
          echo "Server: $TAILSCALE_IP:5900"
          echo "Password: $(echo $RDP_CREDS | cut -d' ' -f4)"
          echo "==================="
          echo ""
          echo "📥 How to Connect:"
          echo "1. Download VNC Viewer: https://www.realvnc.com/download/viewer/"
          echo "2. Server: $TAILSCALE_IP:5900"
          echo "3. Password: $(echo $RDP_CREDS | cut -d' ' -f4)"
          echo ""

      - name: Keep Alive
        run: |
          while true; do
            echo "[$(date +'%H:%M:%S')] VNC Active - $TAILSCALE_IP:5900"
            sleep 300
          done
