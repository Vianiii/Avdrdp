name: VNC-RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install VNC + XFCE
        run: |
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            xfce4 xfce4-terminal x11vnc xvfb dbus-x11
          echo "✅ Installed"

      - name: Start Display & VNC
        run: |
          # Start virtual display
          Xvfb :99 -screen 0 1920x1080x24 > /tmp/xvfb.log 2>&1 &
          sleep 2
          
          # Start XFCE
          DISPLAY=:99 startxfce4 > /tmp/xfce.log 2>&1 &
          sleep 5
          
          # Start VNC (no password needed)
          DISPLAY=:99 x11vnc -forever -nopw -rfbport 5900 -bg
          
          sleep 2
          ps aux | grep x11vnc | grep -v grep
          echo "✅ VNC ready on port 5900"

      - name: Connect Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl start tailscaled
          sleep 5
          
          echo "Connecting Tailscale..."
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=vnc-${{ github.run_id }}
          
          sleep 10
          
          IP=$(sudo tailscale ip -4)
          echo "Tailscale IP: $IP"
          
          if [ -z "$IP" ]; then
            echo "ERROR: Tailscale auth failed!"
            echo "Check your TAILSCALE_AUTH_KEY secret"
            sudo tailscale status
            exit 1
          fi
          
          echo "TAILSCALE_IP=$IP" >> $GITHUB_ENV

      - name: Connection Info
        run: |
          echo ""
          echo "════════════════════════════════════════"
          echo "🖥️  VNC DESKTOP READY!"
          echo "════════════════════════════════════════"
          echo ""
          echo "📱 Server: $TAILSCALE_IP:5900"
          echo "🔑 Password: (none - click Connect)"
          echo ""
          echo "📥 Steps:"
          echo "1. Download: https://www.realvnc.com/download/viewer/"
          echo "2. Server: $TAILSCALE_IP:5900"
          echo "3. Click Connect"
          echo ""
          echo "════════════════════════════════════════"

      - name: Keep Alive
        run: |
          while true; do
            echo "$(date) - VNC Active: $TAILSCALE_IP:5900"
            sleep 300
          done
